(()=>{"use strict";var t={253(t,e,r){var s,n=this&&this.__createBinding||(Object.create?function(t,e,r,s){void 0===s&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}:function(t,e,r,s){void 0===s&&(s=r),t[s]=e[r]}),i=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||(s=function(t){return s=Object.getOwnPropertyNames||function(t){var e=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[e.length]=r);return e},s(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r=s(t),o=0;o<r.length;o++)"default"!==r[o]&&n(e,t,r[o]);return i(e,t),e});Object.defineProperty(e,"__esModule",{value:!0}),e.DahuaDVRIP=void 0;const a=o(r(278)),c=o(r(982)),h=[Buffer.from([160,0]),Buffer.from([160,1]),Buffer.from([160,5]),Buffer.from([176,0]),Buffer.from([176,1]),Buffer.from([163,1]),Buffer.from([179,0]),Buffer.from([246,0])];function u(t){if(t.length<2)return!1;const e=t.subarray(0,2);return h.some(t=>t.equals(e))}function l(t,e=!1){const r=Buffer.alloc(4);return e?r.writeUInt32BE(t):r.writeUInt32LE(t),r}function d(t,e=!1){const r=Buffer.alloc(8);return e?r.writeBigUInt64BE(t):r.writeBigUInt64LE(t),r}e.DahuaDVRIP=class{constructor(t){this.socket=null,this.sessionId=0,this.requestId=0,this.running=!1,this.keepaliveInterval=null,this.buffer=Buffer.alloc(0),this.pendingResolvers=new Map,this.host=t.host,this.port=t.port||37777,this.username=t.username,this.password=t.password,this.console=t.console||console}dahuaGen1Hash(t){const e=c.createHash("md5");e.update(t,"latin1");const r=e.digest(),s=[];for(let t=0;t<r.length;t+=2){let e=(r[t]+r[t+1])%62;e+=e<10?48:e<36?55:61,s.push(e)}return String.fromCharCode(...s)}dahuaGen2Md5Hash(t,e,r,s){const n=c.createHash("md5").update(`${r}:${e}:${s}`,"latin1").digest("hex").toUpperCase();return c.createHash("md5").update(`${r}:${t}:${n}`,"latin1").digest("hex").toUpperCase()}dahuaDvripMd5Hash(t,e,r){const s=this.dahuaGen1Hash(r);return c.createHash("md5").update(`${e}:${t}:${s}`,"latin1").digest("hex").toUpperCase()}buildDvripAuthHash(t,e,r,s){return`${r}&&${this.dahuaGen2Md5Hash(t,e,r,s)}${this.dahuaDvripMd5Hash(t,r,s)}`}async connect(){return new Promise((t,e)=>{this.socket=new a.Socket,this.socket.setTimeout(1e4),this.socket.on("connect",()=>{this.running=!0,this.console.log(`[DVRIP] Connected to ${this.host}:${this.port}`),t()}),this.socket.on("error",t=>{this.console.error(`[DVRIP] Socket error: ${t.message}`),e(t)}),this.socket.on("timeout",()=>{this.console.error("[DVRIP] Socket timeout"),this.socket?.destroy(),e(new Error("Connection timeout"))}),this.socket.on("data",t=>{this.handleData(t)}),this.socket.on("close",()=>{this.running=!1,this.console.log("[DVRIP] Connection closed")}),this.socket.connect(this.port,this.host)})}handleData(t){this.buffer=Buffer.concat([this.buffer,t]),this.processBuffer()}processBuffer(){for(;this.buffer.length>=32;)if(u(this.buffer)){const t=32+this.buffer.readUInt32LE(4);if(!(this.buffer.length>=t))break;{const e=this.buffer.subarray(0,t);this.buffer=this.buffer.subarray(t),this.handlePacket(e)}}else{let t=!1;for(let e=1;e<this.buffer.length-1;e++){const r=this.buffer.subarray(e,e+2);if(h.some(t=>t.equals(r))){this.buffer=this.buffer.subarray(e),t=!0;break}}if(!t){this.buffer=this.buffer.subarray(-1);break}}}handlePacket(t){const e=t.subarray(0,32),r=t.subarray(32);if((246===e[0]||176===e[0])&&r.length>0)try{const t=r.toString("latin1"),e=t.indexOf("{"),s=t.lastIndexOf("}")+1;if(e>=0&&s>e){const r=JSON.parse(t.substring(e,s)),n=r.id;if(n&&this.pendingResolvers.has(n)){const t=this.pendingResolvers.get(n);this.pendingResolvers.delete(n),t.resolve(r)}}}catch(t){}}async login(){if(!this.socket)throw new Error("Not connected");const t=Buffer.from([160,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,2,1,1,0,0,161,170]);this.console.log("[DVRIP] Sending login request..."),this.socket.write(t);const e=await this.waitForData(5e3);if(!e||e.length<32)return this.console.error("[DVRIP] No challenge response"),!1;const r=e.subarray(32).toString("latin1");let s=null,n=null;for(const t of r.split("\n"))t.startsWith("Realm:")?s=t.substring(6).trim():t.startsWith("Random:")&&(n=t.substring(7).trim());if(!s||!n)return this.console.error("[DVRIP] Failed to parse challenge"),!1;this.console.log(`[DVRIP] Realm: ${s}, Random: ${n}`);const i=this.buildDvripAuthHash(n,s,this.username,this.password),o=Buffer.from(i,"latin1"),a=Buffer.concat([l(2684682240,!0),l(o.length),Buffer.alloc(16),d(0x050200080000a1aan,!0)]);this.console.log("[DVRIP] Sending authentication..."),this.socket.write(Buffer.concat([a,o]));const c=await this.waitForData(5e3);if(!c||c.length<32)return this.console.error("[DVRIP] No auth response"),!1;const h=c.subarray(8,10);return 0===h[0]&&8===h[1]?(this.sessionId=c.readUInt32LE(16),this.console.log(`[DVRIP] Login successful! Session ID: ${this.sessionId}`),this.startKeepalive(),!0):(this.console.error(`[DVRIP] Login failed with error code: ${h.toString("hex")}`),!1)}waitForData(t){return new Promise(e=>{const r=this.buffer.length;let s=0;const n=setInterval(()=>{if(s+=100,this.buffer.length>r+32){clearInterval(n);const t=this.buffer;this.buffer=Buffer.alloc(0),e(t)}else s>=t&&(clearInterval(n),e(this.buffer.length>0?this.buffer:null),this.buffer=Buffer.alloc(0))},100)})}startKeepalive(){this.keepaliveInterval=setInterval(()=>{this.running&&this.sendCommand("global.keepAlive",{timeout:30,active:!0}).catch(t=>this.console.error("[DVRIP] Keepalive error:",t.message))},25e3)}async sendCommand(t,e={}){if(!this.socket||!this.running)throw new Error("Not connected");this.requestId++;const r={method:t,params:e,id:this.requestId,session:this.sessionId},s=Buffer.from(JSON.stringify(r),"latin1"),n=Buffer.concat([l(4127195136,!0),l(s.length),l(this.requestId),l(0),l(s.length),l(0),l(this.sessionId),l(0)]);return new Promise((e,r)=>{const i=setTimeout(()=>{this.pendingResolvers.delete(this.requestId),r(new Error(`Command timeout: ${t}`))},1e4);this.pendingResolvers.set(this.requestId,{resolve:t=>{clearTimeout(i),e(t)},reject:t=>{clearTimeout(i),r(t)}}),this.socket.write(Buffer.concat([n,s]))})}async ptzControl(t,e=5,r="start"){const s={channel:0,code:t,arg1:"start"===r?e:0,arg2:"start"===r?e:0,arg3:0,arg4:0},n="start"===r?"ptz.start":"ptz.stop";return this.sendCommand(n,s)}async ptzMove(t,e=5,r=500){await this.ptzControl(t,e,"start"),await new Promise(t=>setTimeout(t,r)),await this.ptzControl(t,0,"stop")}disconnect(){this.running=!1,this.keepaliveInterval&&(clearInterval(this.keepaliveInterval),this.keepaliveInterval=null),this.socket&&(this.socket.destroy(),this.socket=null)}isConnected(){return this.running&&null!==this.socket}}},278(t){t.exports=require("net")},469(t){t.exports=require("@scrypted/sdk")},927(t,e,r){var s,n=this&&this.__createBinding||(Object.create?function(t,e,r,s){void 0===s&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}:function(t,e,r,s){void 0===s&&(s=r),t[s]=e[r]}),i=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||(s=function(t){return s=Object.getOwnPropertyNames||function(t){var e=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[e.length]=r);return e},s(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r=s(t),o=0;o<r.length;o++)"default"!==r[o]&&n(e,t,r[o]);return i(e,t),e});Object.defineProperty(e,"__esModule",{value:!0});const a=o(r(469)),c=r(253),{deviceManager:h,mediaManager:u}=a.default;class l extends a.ScryptedDeviceBase{constructor(t){super(t),this.dvrip=null,this.dvripConnecting=null,this.ptzCapabilities={pan:!0,tilt:!0,zoom:!0}}getHost(){return this.storage.getItem("host")||""}getUsername(){return this.storage.getItem("username")||"admin"}getPassword(){return this.storage.getItem("password")||""}getRtspPort(){return parseInt(this.storage.getItem("rtspPort")||"554")}getDvripPort(){return parseInt(this.storage.getItem("dvripPort")||"37777")}getRtspUrl(t=0){const e=this.getHost();return`rtsp://${encodeURIComponent(this.getUsername())}:${encodeURIComponent(this.getPassword())}@${e}:${this.getRtspPort()}/cam/realmonitor?channel=1&subtype=${t}`}async getSettings(){return[{key:"host",title:"Camera IP Address",value:this.getHost(),type:"string",placeholder:"192.168.1.100"},{key:"username",title:"Username",value:this.getUsername(),type:"string"},{key:"password",title:"Password",value:this.getPassword(),type:"password"},{key:"rtspPort",title:"RTSP Port",value:this.getRtspPort().toString(),type:"number",placeholder:"554"},{key:"dvripPort",title:"DVRIP Port (for PTZ)",value:this.getDvripPort().toString(),type:"number",placeholder:"37777"}]}async putSetting(t,e){this.storage.setItem(t,null!=e?String(e):""),this.dvrip&&(this.dvrip.disconnect(),this.dvrip=null)}async ensureDvripConnected(){if(this.dvrip?.isConnected())return this.dvrip;if(this.dvripConnecting&&(await this.dvripConnecting,this.dvrip?.isConnected()))return this.dvrip;this.dvripConnecting=(async()=>{const t=this.getHost();if(!t)throw new Error("Camera IP not configured");this.dvrip=new c.DahuaDVRIP({host:t,port:this.getDvripPort(),username:this.getUsername(),password:this.getPassword(),console:this.console});try{return await this.dvrip.connect(),await this.dvrip.login()}catch(t){throw this.dvrip.disconnect(),this.dvrip=null,t}})();const t=await this.dvripConnecting;if(this.dvripConnecting=null,!t)throw new Error("DVRIP login failed");return this.dvrip}async getVideoStream(t){const e="substream"===t?.id?1:0,r=this.getRtspUrl(e),s={url:r,inputArguments:["-rtsp_transport","tcp","-i",r]};return u.createFFmpegMediaObject(s)}async getVideoStreamOptions(){return[{id:"mainstream",name:"Main Stream",video:{codec:"h264"},audio:{codec:"aac"}},{id:"substream",name:"Sub Stream",video:{codec:"h264"},audio:{codec:"aac"}}]}async takePicture(t){const e=this.getRtspUrl(1),r={url:e,inputArguments:["-rtsp_transport","tcp","-i",e,"-frames:v","1","-f","image2"]};return u.createFFmpegMediaObject(r)}async getPictureOptions(){return[]}async ptzCommand(t){const e=await this.ensureDvripConnected(),r=t=>void 0===t?0:Math.min(8,Math.max(1,Math.ceil(8*Math.abs(t)))),s=t.pan,n=t.tilt,i=t.zoom;try{if(void 0!==s&&0!==s){const t=s>0?"Right":"Left",n=r(s);await e.ptzControl(t,n,"start"),setTimeout(async()=>{try{await e.ptzControl(t,0,"stop")}catch(t){}},200)}if(void 0!==n&&0!==n){const t=n>0?"Up":"Down",s=r(n);await e.ptzControl(t,s,"start"),setTimeout(async()=>{try{await e.ptzControl(t,0,"stop")}catch(t){}},200)}if(void 0!==i&&0!==i){const t=i>0?"ZoomIn":"ZoomOut",s=r(i);await e.ptzControl(t,s,"start"),setTimeout(async()=>{try{await e.ptzControl(t,0,"stop")}catch(t){}},200)}}catch(t){throw this.console.error("PTZ command error:",t.message),t}}}class d extends a.ScryptedDeviceBase{constructor(t){super(t),this.cameras=new Map}async getSettings(){return[{key:"addCamera",title:"Add Camera",description:"Enter the camera IP address to add a new Amcrest ASH21 camera",type:"string",placeholder:"192.168.1.100"}]}async putSetting(t,e){if("addCamera"===t&&e){const t=String(e);await this.addCamera(t)}}async addCamera(t){const e=`amcrest-ash21-${t.replace(/\./g,"-")}`;await h.onDeviceDiscovered({nativeId:e,name:`Amcrest ASH21 (${t})`,type:a.ScryptedDeviceType.Camera,interfaces:[a.ScryptedInterface.Camera,a.ScryptedInterface.VideoCamera,a.ScryptedInterface.PanTiltZoom,a.ScryptedInterface.Settings]});const r=await this.getDevice(e);r&&r.storage&&r.storage.setItem("host",t)}async getDevice(t){let e=this.cameras.get(t);return e||(e=new l(t),this.cameras.set(t,e)),e}async releaseDevice(t,e){this.cameras.get(e)&&this.cameras.delete(e)}}e.default=new d},982(t){t.exports=require("crypto")}},e={},r=function r(s){var n=e[s];if(void 0!==n)return n.exports;var i=e[s]={exports:{}};return t[s].call(i.exports,i,i.exports,r),i.exports}(927);module.exports=r})();
//# sourceMappingURL=main.nodejs.js.map